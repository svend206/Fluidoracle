# =============================================================
# Fluidoracle FPS (Fluid Power Systems) — Docker Compose
# =============================================================
# Two services:
#   app   — FastAPI backend (serves frontend + API)
#   caddy — Reverse proxy (SSL termination, caching, security)
#
# Usage:
#   docker compose build          # Build the app image
#   docker compose up -d          # Start in background
#   docker compose logs -f        # Watch logs
#   docker compose down           # Stop everything
# =============================================================

services:

  # --- FastAPI Application ---
  app:
    build: .
    container_name: fluidoracle-fps-app
    restart: unless-stopped

    # Only bind to localhost — Caddy handles external traffic
    ports:
      - "127.0.0.1:8000:8000"

    # Production environment variables
    env_file:
      - .env.production

    # Override paths for Docker volume mounts
    environment:
      - PLATFORM_ID=fps
      - CHROMA_PATH=/app/vector-store
      - DATABASE_PATH=/app/data/community.db
      - CORS_ORIGINS=https://fps.fluidoracle.com,https://fluidoracle.com

    volumes:
      # Vector store: ChromaDB needs write access for SQLite WAL/journal files
      - ./vector-store:/app/vector-store

      # SQLite database: read-write (grows with user questions/votes/comments)
      - ./data:/app/data

      # Training exhaust: read-write (JSONL logs for fine-tuning)
      - ./ai/08-training-data:/app/ai/08-training-data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      # RAG warmup loads BM25 + cross-encoder + ChromaDB on startup (~60-120s cold start)
      start_period: 120s


  # --- Caddy Reverse Proxy ---
  caddy:
    image: caddy:2-alpine
    container_name: fluidoracle-fps-caddy
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

    depends_on:
      app:
        condition: service_healthy


volumes:
  caddy_data:
  caddy_config:
